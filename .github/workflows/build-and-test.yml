name: Build and Test

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

env:
  TORCH_VERSION: "2.9.1"
  TORCHVISION_VERSION: "0.24.1"
  CUDA_VERSION: "13.0"
  PIP_NO_PYTHON_VERSION_WARNING: "1"

jobs:
  linux:
    name: Linux (${{ matrix.distro.name }} / py${{ matrix.python-version }})
    runs-on: ubuntu-22.04
    container:
      image: ${{ matrix.distro.image }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
        distro:
          - name: ubuntu-20.04
            image: ubuntu:20.04
            package_manager: apt
          - name: ubuntu-22.04
            image: ubuntu:22.04
            package_manager: apt
          - name: ubuntu-24.04
            image: ubuntu:24.04
            package_manager: apt
          - name: fedora-43
            image: fedora:43
            package_manager: dnf
    env:
      PYTORCH_INDEX_URL: https://download.pytorch.org/whl/cu130
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          if [ "${{ matrix.distro.package_manager }}" = "apt" ]; then
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y \
              git curl wget ca-certificates build-essential ffmpeg libsm6 libxext6 xz-utils \
              bzip2 libbz2-dev unzip
            rm -rf /var/lib/apt/lists/*
          else
            dnf install -y \
              git curl wget ca-certificates gcc gcc-c++ make ffmpeg mesa-libGL libSM libXext xz \
              bzip2 bzip2-libs unzip
          fi

      - name: Install Python ${{ matrix.python-version }}
        shell: bash
        env:
          DISTRO_NAME: ${{ matrix.distro.name }}
          DISTRO_PACKAGE_MANAGER: ${{ matrix.distro.package_manager }}
        run: |
          set -eux
          PY_VER="${{ matrix.python-version }}"
          if [ "${DISTRO_PACKAGE_MANAGER}" = "apt" ]; then
            if [ "${DISTRO_NAME}" = "ubuntu-20.04" ]; then
              SRC_VERSION="${PY_VER}.0"
              BUILD_PREFIX="/opt/python/${SRC_VERSION}"
              apt-get update
              DEBIAN_FRONTEND=noninteractive apt-get install -y \
                build-essential \
                libssl-dev \
                zlib1g-dev \
                libncurses5-dev \
                libncursesw5-dev \
                libreadline-dev \
                libsqlite3-dev \
                libgdbm-dev \
                libdb5.3-dev \
                libbz2-dev \
                libexpat1-dev \
                liblzma-dev \
                tk-dev \
                libffi-dev \
                uuid-dev \
                wget \
                curl
              cd /tmp
              wget -q "https://www.python.org/ftp/python/${SRC_VERSION}/Python-${SRC_VERSION}.tgz"
              tar -xf "Python-${SRC_VERSION}.tgz"
              cd "Python-${SRC_VERSION}"
              ./configure \
                --prefix="${BUILD_PREFIX}" \
                --enable-optimizations \
                --with-ensurepip=install
              make -j"$(nproc)"
              make altinstall
              ln -sf "${BUILD_PREFIX}/bin/python${PY_VER}" "/usr/local/bin/python${PY_VER}"
              ln -sf "${BUILD_PREFIX}/bin/pip${PY_VER}" "/usr/local/bin/pip${PY_VER}" || true
              "/usr/local/bin/python${PY_VER}" --version
            else
              export DEBIAN_FRONTEND=noninteractive
              export TZ=Etc/UTC
              apt-get update
              apt-get install -y tzdata
              ln -fs /usr/share/zoneinfo/${TZ} /etc/localtime
              dpkg-reconfigure -f noninteractive tzdata
              apt-get install -y software-properties-common python3-pip
              add-apt-repository universe -y
              add-apt-repository ppa:deadsnakes/ppa -y
              apt-get update

              # Verify python package is available
              echo "Searching for python${PY_VER} package..."
              # Truncate results; ignore SIGPIPE from apt-cache when head exits early
              apt-cache search "python${PY_VER}" | head -20 || true

              if ! apt-cache show "python${PY_VER}" >/dev/null 2>&1; then
                echo "ERROR: Package python${PY_VER} not found in repositories"
                exit 1
              fi

              apt-get install -y "python${PY_VER}"

              # Verify installation
              if ! command -v "python${PY_VER}" >/dev/null 2>&1; then
                echo "ERROR: python${PY_VER} binary not found after installation"
                exit 1
              fi

              echo "python${PY_VER} installed successfully at: $(command -v python${PY_VER})"
              "python${PY_VER}" --version

              if ! apt-get install -y "python${PY_VER}-venv"; then
                echo "python${PY_VER}-venv not available, will fall back to virtualenv"
              fi
              if apt-cache show "python${PY_VER}-distutils" >/dev/null 2>&1; then
                apt-get install -y "python${PY_VER}-distutils"
              fi
            fi
          else
            dnf install -y \
              "python${PY_VER}" \
              "python${PY_VER}-devel"
          fi

      - name: Create virtual environment
        run: |
          PY_BIN="python${{ matrix.python-version }}"
          PY_BIN_PATH="$(command -v ${PY_BIN} || true)"
          if [ -z "${PY_BIN_PATH}" ]; then
            echo "Unable to locate ${PY_BIN}; ensure it is installed."
            exit 1
          fi
          if ! "${PY_BIN_PATH}" -m venv .venv; then
            echo "Falling back to virtualenv for ${PY_BIN_PATH}"
            python3 -m pip install --upgrade pip
            python3 -m pip install --upgrade virtualenv
            python3 -m virtualenv --python "${PY_BIN_PATH}" .venv
          fi
          . .venv/bin/activate
          python -m pip install --upgrade pip

      - name: Install EgoBlur from source
        env:
          PIP_EXTRA_INDEX_URL: ${{ env.PYTORCH_INDEX_URL }}
        run: |
          . .venv/bin/activate
          pip install --no-cache-dir .

      - name: Smoke test CLI entry points
        run: |
          . .venv/bin/activate
          egoblur-gen2 -h
          egoblur-gen1 -h

      - name: Download EgoBlur Gen2 models
        shell: bash
        env:
          FACE_MODEL_URL: https://scontent-sea5-1.xx.fbcdn.net/m1/v/t6/An8ONis8Gp-rzgPM06SVUcz6MjMEQPau6sgr25xJrEvmEfvr_YRW0UWHKSlOtV3z0fj98V2uqqnPbnLrU0SARtcph53QmA-x3nrdYxFl-OcYe0nOc7Y0BQx4SS7tKF3zXjcPXKiQS8WEl8k7Ag.zip/ego_blur_face_gen2.zip?_nc_gid=Bnqzzs-Hw3TUw2xPOdS8vg&_nc_oc=AdnCyC1Ksl12pYZexXmg6i7tazF6p49YZh_QBOQT91JZlQp3Q7qRMMkiP6oNXcM3EDQ&sdl=1&ccb=10-5&oh=00_AfnfEq9kXuGF18-fZNfXkovu_VgiAioxjmyAMU5fLVFrNg&oe=69586C58&_nc_sid=5cb19f
          LP_MODEL_URL: https://scontent-sea5-1.xx.fbcdn.net/m1/v/t6/An9xrh1Lyyk5EuJPXmDPC2AZQzZp3fLxlw9twrwWc9iNl8PfgzOMs0NehwSRTJN4tZ5iwPh1voT8JFpDeWCzGZnSSsXMaIzNPNjF70lWWMKHiFgOsE-ZT8aP9oTHTXGraEWc5_e3BMssDxgS.zip/ego_blur_lp_gen2.zip?_nc_gid=-efrwVRzJldEhB_POMBZtg&_nc_oc=Adn55ZpzPXSfvFpmDnVLv2yXzVw0O_8xrc82gzPBSQAjpMjyF3t2U6_cur-059H47j4&sdl=1&ccb=10-5&oh=00_AfnH9BBrj206CxDWlxtTDz3NVt3lOD56VSOMttr-qzGktw&oe=6959230A&_nc_sid=5cb19f
        run: |
          set -euxo pipefail
          MODELS_DIR="${PWD}/.ci_gen2_models"
          rm -rf "${MODELS_DIR}"
          mkdir -p "${MODELS_DIR}"
          wget -O "${MODELS_DIR}/ego_blur_face_gen2.zip" ${FACE_MODEL_URL}
          wget -O "${MODELS_DIR}/ego_blur_lp_gen2.zip" ${LP_MODEL_URL}
          unzip -o "${MODELS_DIR}/ego_blur_face_gen2.zip" -d "${MODELS_DIR}"
          unzip -o "${MODELS_DIR}/ego_blur_lp_gen2.zip" -d "${MODELS_DIR}"
          FACE_MODEL_PATH="$(find "${MODELS_DIR}" -maxdepth 2 -name 'ego_blur_face_gen2*.jit' -print -quit || true)"
          LP_MODEL_PATH="$(find "${MODELS_DIR}" -maxdepth 2 -name 'ego_blur_lp_gen2*.jit' -print -quit || true)"
          if [ -z "${FACE_MODEL_PATH}" ]; then
            echo "::error::Unable to locate ego_blur_face_gen2 model after extraction"
            exit 1
          fi
          if [ -z "${LP_MODEL_PATH}" ]; then
            echo "::error::Unable to locate ego_blur_lp_gen2 model after extraction"
            exit 1
          fi
          echo "FACE_MODEL_PATH=${FACE_MODEL_PATH}" >> "${GITHUB_ENV}"
          echo "LP_MODEL_PATH=${LP_MODEL_PATH}" >> "${GITHUB_ENV}"

      - name: Run Gen2 demo inference
        shell: bash
        env:
          OUTPUT_DIR: ${{ github.workspace }}/gen2/demo_assets/output
        run: |
          set -euxo pipefail
          . .venv/bin/activate
          mkdir -p "${OUTPUT_DIR}"
          egoblur-gen2 \
            --face_model_path "${FACE_MODEL_PATH}" \
            --input_image_path "${PWD}/gen2/demo_assets/test_face_image.png" \
            --output_image_path "${OUTPUT_DIR}/test_face_image_ci.png" \
            --scale_factor_detections 1.0
          egoblur-gen2 \
            --lp_model_path "${LP_MODEL_PATH}" \
            --input_image_path "${PWD}/gen2/demo_assets/test_lp_image.png" \
            --output_image_path "${OUTPUT_DIR}/test_lp_image_ci.png" \
            --scale_factor_detections 1.0

      - name: Upload Gen2 inference artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gen2-inference-${{ matrix.distro.name }}-py${{ matrix.python-version }}
          if-no-files-found: error
          path: |
            gen2/demo_assets/output/test_face_image_ci.png
            gen2/demo_assets/output/test_lp_image_ci.png

      - name: Download EgoBlur Gen1 models
        shell: bash
        env:
          FACE_MODEL_URL_GEN1: https://scontent-sea5-1.xx.fbcdn.net/m1/v/t6/An9YkFJt5-RDfoSOiDFYj4HAhU4V8n_gblPTiEmoHFpxRFNds5u7hp3PprTc-pA0J3Wd5wuqZswtWIJ8dqXGgQk0hHuDvWA9SeY7fiybc4URyZEirJIQb32tFqEl43wnMRLjsZhWMW3D1w9imw.zip/ego_blur_face_gen1.zip?_nc_gid=tm5t3x8OXvxj8CUw_6TQfg&_nc_oc=Adn7wurDKNH1YKwqA1gHt0M1pngcQzZgrTCieg3RzxQCbexHIZkszQozTfzA3t5ibCc&sdl=1&ccb=10-5&oh=00_Afk0uvH6mIWJpEQO7_YGmV8q19dDQg9DD-gygOdL8hs80w&oe=6959555B&_nc_sid=5cb19f
          LP_MODEL_URL_GEN1: https://scontent-sea5-1.xx.fbcdn.net/m1/v/t6/An9pUFOkrNfXT1_t-HiCMftPO-8i63zVA2M_ELmoOihi0NxnomQcl_NJ8xcffcwMghaFSAarzGwW94DSWhSHAoZ0Lsh5AlAsMJ_3zWA_cGzclahF5mY9rSE2HGpiaGma6uQnvxpkKkhcKo_0.zip/ego_blur_lp_gen1.zip?_nc_gid=tm5t3x8OXvxj8CUw_6TQfg&_nc_oc=Adk-91VnCT7-DOu4N5sijd7DfwRdMtHrQMn-EYBjhCTFdQzc0R7gLC6hZQaFvj15_84&sdl=1&ccb=10-5&oh=00_Afm_IztQeIZ2_fU3pJZGUBobO1_74mjAC8MI40_U6aHwfw&oe=69596716&_nc_sid=5cb19f
        run: |
          set -euxo pipefail
          MODELS_DIR="${PWD}/.ci_gen1_models"
          rm -rf "${MODELS_DIR}"
          mkdir -p "${MODELS_DIR}"
          wget -O "${MODELS_DIR}/ego_blur_face_gen1.zip" "${FACE_MODEL_URL_GEN1}"
          wget -O "${MODELS_DIR}/ego_blur_lp_gen1.zip" "${LP_MODEL_URL_GEN1}"
          unzip -o "${MODELS_DIR}/ego_blur_face_gen1.zip" -d "${MODELS_DIR}"
          unzip -o "${MODELS_DIR}/ego_blur_lp_gen1.zip" -d "${MODELS_DIR}"
          FACE_MODEL_PATH_GEN1="$(find "${MODELS_DIR}" -maxdepth 2 -name 'ego_blur_face_gen1*.jit' -print -quit || true)"
          LP_MODEL_PATH_GEN1="$(find "${MODELS_DIR}" -maxdepth 2 -name 'ego_blur_lp_gen1*.jit' -print -quit || true)"
          if [ -z "${FACE_MODEL_PATH_GEN1}" ]; then
            echo "::error::Unable to locate ego_blur_face_gen1 model after extraction"
            exit 1
          fi
          if [ -z "${LP_MODEL_PATH_GEN1}" ]; then
            echo "::error::Unable to locate ego_blur_lp_gen1 model after extraction"
            exit 1
          fi
          echo "FACE_MODEL_PATH_GEN1=${FACE_MODEL_PATH_GEN1}" >> "${GITHUB_ENV}"
          echo "LP_MODEL_PATH_GEN1=${LP_MODEL_PATH_GEN1}" >> "${GITHUB_ENV}"

      - name: Run Gen1 demo inference
        shell: bash
        env:
          OUTPUT_DIR: ${{ github.workspace }}/gen1/demo_assets/output
        run: |
          set -euxo pipefail
          . .venv/bin/activate
          mkdir -p "${OUTPUT_DIR}"
          egoblur-gen1 \
            --face_model_path "${FACE_MODEL_PATH_GEN1}" \
            --input_image_path "${PWD}/gen1/demo_assets/test_image.jpg" \
            --output_image_path "${OUTPUT_DIR}/test_face_image_ci_gen1.png" \
            --scale_factor_detections 1.0

      - name: Upload Gen1 inference artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gen1-inference-${{ matrix.distro.name }}-py${{ matrix.python-version }}
          if-no-files-found: error
          path: |
            gen1/demo_assets/output/test_face_image_ci_gen1.png

  macos:
    name: macOS (${{ matrix.runner }} / py${{ matrix.python-version }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        runner: [ "macos-14", "macos-15"]
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Ensure system dependencies
        env:
          HOMEBREW_NO_AUTO_UPDATE: "1"
          HOMEBREW_NO_INSTALL_CLEANUP: "1"
          HOMEBREW_NO_ANALYTICS: "1"
        run: |
          if ! command -v ffmpeg >/dev/null 2>&1; then
            brew install ffmpeg
          else
            ffmpeg -version
          fi

      - name: Create virtual environment
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip

      - name: Install EgoBlur from source
        run: |
          . .venv/bin/activate
          pip install --no-cache-dir .

      - name: Smoke test CLI entry points
        run: |
          . .venv/bin/activate
          egoblur-gen2 -h
          egoblur-gen1 -h

      - name: Download EgoBlur Gen2 models
        shell: bash
        env:
          FACE_MODEL_URL: https://scontent-sea5-1.xx.fbcdn.net/m1/v/t6/An8ONis8Gp-rzgPM06SVUcz6MjMEQPau6sgr25xJrEvmEfvr_YRW0UWHKSlOtV3z0fj98V2uqqnPbnLrU0SARtcph53QmA-x3nrdYxFl-OcYe0nOc7Y0BQx4SS7tKF3zXjcPXKiQS8WEl8k7Ag.zip/ego_blur_face_gen2.zip?_nc_gid=Bnqzzs-Hw3TUw2xPOdS8vg&_nc_oc=AdnCyC1Ksl12pYZexXmg6i7tazF6p49YZh_QBOQT91JZlQp3Q7qRMMkiP6oNXcM3EDQ&sdl=1&ccb=10-5&oh=00_AfnfEq9kXuGF18-fZNfXkovu_VgiAioxjmyAMU5fLVFrNg&oe=69586C58&_nc_sid=5cb19f
          LP_MODEL_URL: https://scontent-sea5-1.xx.fbcdn.net/m1/v/t6/An9xrh1Lyyk5EuJPXmDPC2AZQzZp3fLxlw9twrwWc9iNl8PfgzOMs0NehwSRTJN4tZ5iwPh1voT8JFpDeWCzGZnSSsXMaIzNPNjF70lWWMKHiFgOsE-ZT8aP9oTHTXGraEWc5_e3BMssDxgS.zip/ego_blur_lp_gen2.zip?_nc_gid=-efrwVRzJldEhB_POMBZtg&_nc_oc=Adn55ZpzPXSfvFpmDnVLv2yXzVw0O_8xrc82gzPBSQAjpMjyF3t2U6_cur-059H47j4&sdl=1&ccb=10-5&oh=00_AfnH9BBrj206CxDWlxtTDz3NVt3lOD56VSOMttr-qzGktw&oe=6959230A&_nc_sid=5cb19f
        run: |
          set -euxo pipefail
          MODELS_DIR="${PWD}/.ci_gen2_models"
          rm -rf "${MODELS_DIR}"
          mkdir -p "${MODELS_DIR}"
          wget -O "${MODELS_DIR}/ego_blur_face_gen2.zip" ${FACE_MODEL_URL}
          wget -O "${MODELS_DIR}/ego_blur_lp_gen2.zip" ${LP_MODEL_URL}
          unzip -o "${MODELS_DIR}/ego_blur_face_gen2.zip" -d "${MODELS_DIR}"
          unzip -o "${MODELS_DIR}/ego_blur_lp_gen2.zip" -d "${MODELS_DIR}"
          FACE_MODEL_PATH="$(find "${MODELS_DIR}" -maxdepth 2 -name 'ego_blur_face_gen2*.jit' -print -quit || true)"
          LP_MODEL_PATH="$(find "${MODELS_DIR}" -maxdepth 2 -name 'ego_blur_lp_gen2*.jit' -print -quit || true)"
          if [ -z "${FACE_MODEL_PATH}" ]; then
            echo "::error::Unable to locate ego_blur_face_gen2 model after extraction"
            exit 1
          fi
          if [ -z "${LP_MODEL_PATH}" ]; then
            echo "::error::Unable to locate ego_blur_lp_gen2 model after extraction"
            exit 1
          fi
          echo "FACE_MODEL_PATH=${FACE_MODEL_PATH}" >> "${GITHUB_ENV}"
          echo "LP_MODEL_PATH=${LP_MODEL_PATH}" >> "${GITHUB_ENV}"

      - name: Run Gen2 demo inference
        shell: bash
        env:
          OUTPUT_DIR: ${{ github.workspace }}/gen2/demo_assets/output
        run: |
          set -euxo pipefail
          . .venv/bin/activate
          mkdir -p "${OUTPUT_DIR}"
          egoblur-gen2 \
            --face_model_path "${FACE_MODEL_PATH}" \
            --input_image_path "${PWD}/gen2/demo_assets/test_face_image.png" \
            --output_image_path "${OUTPUT_DIR}/test_face_image_ci.png" \
            --scale_factor_detections 1.0
          egoblur-gen2 \
            --lp_model_path "${LP_MODEL_PATH}" \
            --input_image_path "${PWD}/gen2/demo_assets/test_lp_image.png" \
            --output_image_path "${OUTPUT_DIR}/test_lp_image_ci.png" \
            --scale_factor_detections 1.0

      - name: Upload Gen2 inference artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gen2-inference-${{ matrix.runner }}-py${{ matrix.python-version }}
          if-no-files-found: error
          path: |
            gen2/demo_assets/output/test_face_image_ci.png
            gen2/demo_assets/output/test_lp_image_ci.png

      - name: Download EgoBlur Gen1 models
        shell: bash
        env:
          FACE_MODEL_URL_GEN1: https://scontent-sea5-1.xx.fbcdn.net/m1/v/t6/An9YkFJt5-RDfoSOiDFYj4HAhU4V8n_gblPTiEmoHFpxRFNds5u7hp3PprTc-pA0J3Wd5wuqZswtWIJ8dqXGgQk0hHuDvWA9SeY7fiybc4URyZEirJIQb32tFqEl43wnMRLjsZhWMW3D1w9imw.zip/ego_blur_face_gen1.zip?_nc_gid=tm5t3x8OXvxj8CUw_6TQfg&_nc_oc=Adn7wurDKNH1YKwqA1gHt0M1pngcQzZgrTCieg3RzxQCbexHIZkszQozTfzA3t5ibCc&sdl=1&ccb=10-5&oh=00_Afk0uvH6mIWJpEQO7_YGmV8q19dDQg9DD-gygOdL8hs80w&oe=6959555B&_nc_sid=5cb19f
          LP_MODEL_URL_GEN1: https://scontent-sea5-1.xx.fbcdn.net/m1/v/t6/An9pUFOkrNfXT1_t-HiCMftPO-8i63zVA2M_ELmoOihi0NxnomQcl_NJ8xcffcwMghaFSAarzGwW94DSWhSHAoZ0Lsh5AlAsMJ_3zWA_cGzclahF5mY9rSE2HGpiaGma6uQnvxpkKkhcKo_0.zip/ego_blur_lp_gen1.zip?_nc_gid=tm5t3x8OXvxj8CUw_6TQfg&_nc_oc=Adk-91VnCT7-DOu4N5sijd7DfwRdMtHrQMn-EYBjhCTFdQzc0R7gLC6hZQaFvj15_84&sdl=1&ccb=10-5&oh=00_Afm_IztQeIZ2_fU3pJZGUBobO1_74mjAC8MI40_U6aHwfw&oe=69596716&_nc_sid=5cb19f
        run: |
          set -euxo pipefail
          MODELS_DIR="${PWD}/.ci_gen1_models"
          rm -rf "${MODELS_DIR}"
          mkdir -p "${MODELS_DIR}"
          wget -O "${MODELS_DIR}/ego_blur_face_gen1.zip" "${FACE_MODEL_URL_GEN1}"
          wget -O "${MODELS_DIR}/ego_blur_lp_gen1.zip" "${LP_MODEL_URL_GEN1}"
          unzip -o "${MODELS_DIR}/ego_blur_face_gen1.zip" -d "${MODELS_DIR}"
          unzip -o "${MODELS_DIR}/ego_blur_lp_gen1.zip" -d "${MODELS_DIR}"
          FACE_MODEL_PATH_GEN1="$(find "${MODELS_DIR}" -maxdepth 2 -name 'ego_blur_face_gen1*.jit' -print -quit || true)"
          LP_MODEL_PATH_GEN1="$(find "${MODELS_DIR}" -maxdepth 2 -name 'ego_blur_lp_gen1*.jit' -print -quit || true)"
          if [ -z "${FACE_MODEL_PATH_GEN1}" ]; then
            echo "::error::Unable to locate ego_blur_face_gen1 model after extraction"
            exit 1
          fi
          if [ -z "${LP_MODEL_PATH_GEN1}" ]; then
            echo "::error::Unable to locate ego_blur_lp_gen1 model after extraction"
            exit 1
          fi
          echo "FACE_MODEL_PATH_GEN1=${FACE_MODEL_PATH_GEN1}" >> "${GITHUB_ENV}"
          echo "LP_MODEL_PATH_GEN1=${LP_MODEL_PATH_GEN1}" >> "${GITHUB_ENV}"

      - name: Run Gen1 demo inference
        shell: bash
        env:
          OUTPUT_DIR: ${{ github.workspace }}/gen1/demo_assets/output
        run: |
          set -euxo pipefail
          . .venv/bin/activate
          mkdir -p "${OUTPUT_DIR}"
          egoblur-gen1 \
            --face_model_path "${FACE_MODEL_PATH_GEN1}" \
            --lp_model_path "${LP_MODEL_PATH_GEN1}" \
            --input_image_path "${PWD}/gen1/demo_assets/test_image.jpg" \
            --output_image_path "${OUTPUT_DIR}/test_face_image_ci_gen1.png" \
            --scale_factor_detections 1.0

      - name: Upload Gen1 inference artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gen1-inference-${{ matrix.runner }}-py${{ matrix.python-version }}
          if-no-files-found: error
          path: |
            gen1/demo_assets/output/test_face_image_ci_gen1.png
